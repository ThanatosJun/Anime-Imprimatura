doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Generate Visitor
    link(rel='stylesheet', href='/stylesheets/style.css')
  body.generate-visitor
    header.navigation-bar
      .logo-placeholder
      .nav
        a(href="/") Home
        a(href="/#how-to-use") How to Use
        a(href="/#about-us") About Us
        a(href="/gallery") Gallery
      a.login-btn(href="login") Log In
    .content
      form(id="uploadForm", method="post", action="/upload", enctype="multipart/form-data")
        .upload-section
          .upload
            span Upload CHD*3
            .upload-box#uploadBox1
              input(type="file" name="chd" accept="image/*" multiple onchange="handleFiles(this.files, 'uploadBox1')")
          .upload
            span Upload CHS
            .upload-box#uploadBox2
              input(type="file" name="chs" accept="image/*" onchange="handleFiles(this.files, 'uploadBox2')")
        button(type="button" class="generate-btn" onclick="submitForm()") ⚡ Generate

    script.
      let imagePaths = { uploadBox1: [], uploadBox2: [] };

      function handleFiles(files, containerId) {
          console.log('Handling files for:', containerId);
          console.log('Files:', files);

          const container = document.getElementById(containerId);
          if (!container) {
              console.error('Container not found:', containerId);
              return;
          }

          const maxFiles = containerId === 'uploadBox1' ? 3 : 1;

          // 清除以前的預覽
          const existingPreviews = container.querySelectorAll('img');
          existingPreviews.forEach(img => container.removeChild(img));

          // 清除以前的文件路徑
          imagePaths[containerId] = [];

          // 只處理最多允許數量的文件
          Array.from(files).slice(0, maxFiles).forEach(file => {
              const img = document.createElement('img');
              img.classList.add('preview');
              img.file = file;

              const reader = new FileReader();
              reader.onload = (function(aImg) {
                  return function(e) {
                      aImg.src = e.target.result;
                      console.log('Preview added for:', aImg.src);
                  };
              })(img);
              reader.readAsDataURL(file);

              container.appendChild(img);
              imagePaths[containerId].push(URL.createObjectURL(file));
          });

          console.log('Image paths:', imagePaths);
      }
      function submitForm() {
        const form = document.getElementById('uploadForm');
        const formData = new FormData(form);

        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          console.log('Response status:', response.status);
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Upload failed');
          }
        })
        .then(data => {
          console.log('Success:', data);
          // 在這裡處理生成圖片後的跳轉邏輯
          window.location.href = '/generated';
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      }

